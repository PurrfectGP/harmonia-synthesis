<!--
    Harmonia Apex Match - Module 3: Assessment (The Sins & Perceived Similarity)

    Spec Reference: README.md Section 5 - "The Inquiry Deck Interface"
    CSS Classes: css/5-modules.css (.module-assessment, .assessment-*)
    Components: particles.js, cardinal-driver-icons.js

    Research Applied:
    - Card stack UI pattern
    - Accessible button groups (WCAG 2.2)
    - ARIA live regions for dynamic content
    - Data attributes for Cardinal Driver mapping
    - Keyboard navigation (Tab, Enter, Space)
-->

<section class="module-assessment" id="module-assessment" data-module="assessment" data-step="3" aria-labelledby="assessment-title">
    <div class="assessment-container">
        <!-- Title (Hidden visually but available to screen readers) -->
        <h1 class="sr-only" id="assessment-title">Psychometric Assessment - The Inquiry Deck</h1>

        <div class="assessment-instructions" style="text-align: center; margin-bottom: 2rem;">
            <h2 style="font-family: var(--font-display); font-size: 1.75rem; color: var(--color-mediterranean-500); margin-bottom: 0.5rem;">
                The Inquiry Deck
            </h2>
            <p style="font-family: var(--font-body); color: var(--color-parchment-900); opacity: 0.8;">
                Answer each question based on your authentic preferences.
                This assessment maps your personality across 7 Cardinal Drivers (35% of match score).
            </p>
        </div>

        <!-- Assessment Layout: Card Stack (left) + Progress Tube (right) -->
        <div class="assessment-layout" style="display: flex; gap: 2rem; align-items: stretch;">

            <!-- Card Stack Area -->
            <div class="assessment-card-area" style="flex: 1;">
                <!-- Active Question Card -->
                <article
                    class="assessment-card"
                    id="assessment-card"
                    data-question-index="0"
                    data-cardinal-driver=""
                    data-question-id=""
                    role="region"
                    aria-labelledby="current-question-text"
                >
                    <!-- Cardinal Driver Icon Watermark (Behind Text) -->
                    <div class="assessment-card-watermark" id="card-watermark" aria-hidden="true">
                        <!-- SVG icon injected dynamically based on Cardinal Driver -->
                        <svg class="cardinal-icon" width="200" height="200" viewBox="0 0 200 200">
                            <!-- Icon content loaded dynamically -->
                        </svg>
                    </div>

                    <!-- Question Text -->
                    <h3 class="assessment-question-text" id="current-question-text">
                        <!-- Question text inserted dynamically -->
                    </h3>

                    <!-- Binary Choice Buttons (A vs B) -->
                    <div class="assessment-choices" role="group" aria-labelledby="current-question-text">
                        <button
                            type="button"
                            class="assessment-choice-btn"
                            id="choice-a"
                            data-choice="A"
                            aria-label="Choice A"
                        >
                            <!-- Choice A text inserted dynamically -->
                        </button>

                        <button
                            type="button"
                            class="assessment-choice-btn"
                            id="choice-b"
                            data-choice="B"
                            aria-label="Choice B"
                        >
                            <!-- Choice B text inserted dynamically -->
                        </button>
                    </div>

                    <!-- Particle Container for Gold Dust Effect -->
                    <div class="assessment-particles" id="card-particles" aria-hidden="true"></div>
                </article>

                <!-- Card Stack Hint (shows depth illusion) -->
                <div class="assessment-card-stack-hint" aria-hidden="true">
                    <div class="stack-card-2"></div>
                    <div class="stack-card-3"></div>
                </div>
            </div>

            <!-- Vertical Progress Tube (Right Side) -->
            <aside class="assessment-progress-tube" aria-labelledby="progress-tube-label">
                <div class="sr-only" id="progress-tube-label">Assessment Progress</div>

                <!-- Glass Tube Container -->
                <div class="progress-tube-container" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" aria-label="Assessment progress">
                    <!-- Liquid Fill (animates upward as questions are answered) -->
                    <div class="progress-tube-liquid" id="progress-liquid" style="height: 0%;"></div>

                    <!-- Measurement Markers -->
                    <div class="progress-tube-markers" aria-hidden="true">
                        <span class="tube-marker" style="bottom: 0%;">0</span>
                        <span class="tube-marker" style="bottom: 25%;">25</span>
                        <span class="tube-marker" style="bottom: 50%;">50</span>
                        <span class="tube-marker" style="bottom: 75%;">75</span>
                        <span class="tube-marker" style="bottom: 100%;">100</span>
                    </div>

                    <!-- Bubble Animation (Optional) -->
                    <div class="progress-tube-bubbles" aria-hidden="true"></div>
                </div>

                <!-- Progress Text -->
                <div class="progress-tube-text" role="status" aria-live="polite" aria-atomic="true">
                    <span id="current-question-num">1</span> of <span id="total-questions">7</span> questions
                </div>
            </aside>
        </div>

        <!-- Cardinal Drivers Legend (below card stack) -->
        <section class="assessment-drivers-legend" aria-labelledby="drivers-legend-title" style="margin-top: 3rem;">
            <h3 class="sr-only" id="drivers-legend-title">Seven Cardinal Drivers</h3>

            <div class="drivers-legend-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem;">
                <!-- Driver Badge: Passion -->
                <div class="driver-badge" data-driver="passion" aria-label="Passion driver">
                    <svg class="driver-icon" width="24" height="24" viewBox="0 0 24 24" aria-hidden="true">
                        <!-- Passion icon (flame) -->
                    </svg>
                    <span class="driver-label">Passion</span>
                </div>

                <!-- Driver Badge: Indulgence -->
                <div class="driver-badge" data-driver="indulgence" aria-label="Indulgence driver">
                    <svg class="driver-icon" width="24" height="24" viewBox="0 0 24 24" aria-hidden="true">
                        <!-- Indulgence icon (wine glass) -->
                    </svg>
                    <span class="driver-label">Indulgence</span>
                </div>

                <!-- Driver Badge: Ambition -->
                <div class="driver-badge" data-driver="ambition" aria-label="Ambition driver">
                    <svg class="driver-icon" width="24" height="24" viewBox="0 0 24 24" aria-hidden="true">
                        <!-- Ambition icon (mountain) -->
                    </svg>
                    <span class="driver-label">Ambition</span>
                </div>

                <!-- Driver Badge: Serenity -->
                <div class="driver-badge" data-driver="serenity" aria-label="Serenity driver">
                    <svg class="driver-icon" width="24" height="24" viewBox="0 0 24 24" aria-hidden="true">
                        <!-- Serenity icon (lotus) -->
                    </svg>
                    <span class="driver-label">Serenity</span>
                </div>

                <!-- Driver Badge: Conviction -->
                <div class="driver-badge" data-driver="conviction" aria-label="Conviction driver">
                    <svg class="driver-icon" width="24" height="24" viewBox="0 0 24 24" aria-hidden="true">
                        <!-- Conviction icon (anchor) -->
                    </svg>
                    <span class="driver-label">Conviction</span>
                </div>

                <!-- Driver Badge: Yearning -->
                <div class="driver-badge" data-driver="yearning" aria-label="Yearning driver">
                    <svg class="driver-icon" width="24" height="24" viewBox="0 0 24 24" aria-hidden="true">
                        <!-- Yearning icon (compass) -->
                    </svg>
                    <span class="driver-label">Yearning</span>
                </div>

                <!-- Driver Badge: Dignity -->
                <div class="driver-badge" data-driver="dignity" aria-label="Dignity driver">
                    <svg class="driver-icon" width="24" height="24" viewBox="0 0 24 24" aria-hidden="true">
                        <!-- Dignity icon (crown) -->
                    </svg>
                    <span class="driver-label">Dignity</span>
                </div>
            </div>
        </section>
    </div>
</section>

<!-- Template: Question Card Data Structure -->
<template id="question-card-template">
    <div class="question-data">
        <!-- Template for question object structure (used by JavaScript) -->
    </div>
</template>

<!-- Initialization Script Template -->
<script type="module">
    // This script would be in a separate file in the final implementation

    /*
    // Assessment Data
    const assessmentData = {
        questions: [
            {
                id: 1,
                driver: 'passion',
                text: 'When you envision your ideal intimate relationship:',
                choices: {
                    A: 'You prioritize intense emotional connection and vulnerability',
                    B: 'You value steady companionship and mutual respect'
                }
            },
            {
                id: 2,
                driver: 'indulgence',
                text: 'Your approach to life\'s pleasures:',
                choices: {
                    A: 'You embrace spontaneous experiences and sensory delight',
                    B: 'You prefer measured enjoyment and mindful moderation'
                }
            },
            {
                id: 3,
                driver: 'ambition',
                text: 'In your pursuit of personal goals:',
                choices: {
                    A: 'You are driven by achievement and constant growth',
                    B: 'You prioritize balance and sustainable progress'
                }
            },
            {
                id: 4,
                driver: 'serenity',
                text: 'When facing life\'s uncertainties:',
                choices: {
                    A: 'You find peace in acceptance and present-moment awareness',
                    B: 'You seek control through planning and preparation'
                }
            },
            {
                id: 5,
                driver: 'conviction',
                text: 'Your relationship with your core values:',
                choices: {
                    A: 'You hold firm principles that guide all decisions',
                    B: 'You adapt your approach based on context and nuance'
                }
            },
            {
                id: 6,
                driver: 'yearning',
                text: 'Your emotional orientation toward the future:',
                choices: {
                    A: 'You feel a constant pull toward something greater',
                    B: 'You find fulfillment in your current circumstances'
                }
            },
            {
                id: 7,
                driver: 'dignity',
                text: 'Your sense of self-worth derives from:',
                choices: {
                    A: 'Inherent personal value independent of achievement',
                    B: 'Accomplishments and external validation'
                }
            }
        ],
        currentIndex: 0,
        answers: [],
        startTime: null
    };

    // Cardinal Driver Icon Map (SVG paths)
    const cardinalIcons = {
        passion: '<path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>',
        indulgence: '<path d="M6 3v18h12V3H6zm10 16H8V5h8v14zM11 7h2v2h-2zm0 4h2v2h-2zm0 4h2v2h-2z"/>',
        ambition: '<path d="M14 2L8 13h5l-1 9 6-11h-5l1-9z"/>',
        serenity: '<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/>',
        conviction: '<path d="M17 4h3v16h-3zM5 14h3v6H5zM11 9h3v11h-3z"/>',
        yearning: '<path d="M12 2L4 9l8 7 8-7-8-7z"/>',
        dignity: '<path d="M12 2l-2 5H5l4 3.5L7 15l5-3.5 5 3.5-2-4.5L19 7h-5l-2-5z"/>'
    };

    // Initialize Assessment Module
    function initAssessment() {
        const card = document.getElementById('assessment-card');
        const questionText = document.getElementById('current-question-text');
        const choiceA = document.getElementById('choice-a');
        const choiceB = document.getElementById('choice-b');
        const watermark = document.getElementById('card-watermark');
        const progressLiquid = document.getElementById('progress-liquid');
        const currentQuestionNum = document.getElementById('current-question-num');
        const particles = document.getElementById('card-particles');

        assessmentData.startTime = performance.now();

        // Load question
        function loadQuestion(index) {
            if (index >= assessmentData.questions.length) {
                completeAssessment();
                return;
            }

            const question = assessmentData.questions[index];

            // Update card data attributes
            card.dataset.questionIndex = index;
            card.dataset.cardinalDriver = question.driver;
            card.dataset.questionId = question.id;

            // Update question text
            questionText.textContent = question.text;

            // Update choice buttons
            choiceA.textContent = question.choices.A;
            choiceA.setAttribute('aria-label', `Choice A: ${question.choices.A}`);

            choiceB.textContent = question.choices.B;
            choiceB.setAttribute('aria-label', `Choice B: ${question.choices.B}`);

            // Update watermark icon
            const iconSvg = cardinalIcons[question.driver];
            if (watermark && iconSvg) {
                watermark.querySelector('.cardinal-icon').innerHTML = iconSvg;
                watermark.style.opacity = '0.1';
            }

            // Update progress counter
            currentQuestionNum.textContent = index + 1;

            // Entrance animation
            card.style.opacity = '0';
            card.style.transform = 'translateY(20px)';

            setTimeout(() => {
                card.style.transition = 'all 0.5s cubic-bezier(0.4, 0.0, 0.2, 1)';
                card.style.opacity = '1';
                card.style.transform = 'translateY(0)';
            }, 100);
        }

        // Handle answer selection
        function handleAnswer(choice) {
            const questionIndex = parseInt(card.dataset.questionIndex);
            const question = assessmentData.questions[questionIndex];

            // Record answer
            assessmentData.answers.push({
                questionId: question.id,
                driver: question.driver,
                choice: choice,
                timestamp: performance.now() - assessmentData.startTime
            });

            // Gold dust dissolve animation
            card.classList.add('dissolving');
            triggerParticleEffect(particles);

            // Update progress tube
            const progress = ((questionIndex + 1) / assessmentData.questions.length) * 100;
            progressLiquid.style.height = `${progress}%`;
            progressLiquid.parentElement.setAttribute('aria-valuenow', progress);

            // Load next question after animation
            setTimeout(() => {
                card.classList.remove('dissolving');
                assessmentData.currentIndex++;
                loadQuestion(assessmentData.currentIndex);
            }, 1000);
        }

        // Particle effect for card dissolution
        function triggerParticleEffect(container) {
            if (!container) return;

            // Create gold dust particles
            for (let i = 0; i < 30; i++) {
                const particle = document.createElement('div');
                particle.className = 'gold-particle';
                particle.style.left = `${Math.random() * 100}%`;
                particle.style.top = `${Math.random() * 100}%`;
                particle.style.animationDelay = `${Math.random() * 0.5}s`;
                container.appendChild(particle);

                // Remove particle after animation
                setTimeout(() => particle.remove(), 2000);
            }
        }

        // Complete assessment
        function completeAssessment() {
            // Save assessment data
            // Navigate to Module 4: Analysis
        }

        // Event Listeners
        choiceA.addEventListener('click', () => handleAnswer('A'));
        choiceB.addEventListener('click', () => handleAnswer('B'));

        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            if (e.key === 'a' || e.key === 'A') {
                choiceA.click();
            } else if (e.key === 'b' || e.key === 'B') {
                choiceB.click();
            }
        });

        // Initialize first question
        loadQuestion(0);
    }

    // Start on load
    document.addEventListener('DOMContentLoaded', initAssessment);
    */
</script>

<style>
    /* Additional module-specific styles */

    .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
    }

    .assessment-layout {
        min-height: 500px;
    }

    /* Card Stack Depth Illusion */
    .assessment-card-stack-hint {
        position: relative;
        margin-top: -400px;
        height: 0;
        pointer-events: none;
        z-index: -1;
    }

    .stack-card-2,
    .stack-card-3 {
        position: absolute;
        width: 95%;
        height: 380px;
        background: var(--color-parchment-100);
        border: 1px solid rgba(212, 175, 55, 0.2);
        border-radius: var(--radius-lg);
        opacity: 0.5;
    }

    .stack-card-2 {
        top: 10px;
        left: 50%;
        transform: translateX(-50%) scale(0.98);
    }

    .stack-card-3 {
        top: 20px;
        left: 50%;
        transform: translateX(-50%) scale(0.96);
    }

    /* Gold Dust Particle Effect */
    .assessment-particles {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        overflow: hidden;
    }

    .gold-particle {
        position: absolute;
        width: 4px;
        height: 4px;
        background: var(--color-champagne-500);
        border-radius: 50%;
        animation: particle-float-up 2s ease-out forwards;
        opacity: 1;
    }

    @keyframes particle-float-up {
        0% {
            transform: translateY(0) translateX(0) scale(1);
            opacity: 1;
        }
        100% {
            transform: translateY(-100px) translateX(var(--random-x, 0)) scale(0);
            opacity: 0;
        }
    }

    /* Card Dissolve Animation */
    .assessment-card.dissolving {
        animation: card-dissolve 1s cubic-bezier(0.4, 0.0, 0.2, 1) forwards;
    }

    @keyframes card-dissolve {
        0% {
            opacity: 1;
            transform: scale(1) rotate(0deg);
        }
        50% {
            opacity: 0.5;
            transform: scale(0.95) rotate(2deg);
        }
        100% {
            opacity: 0;
            transform: scale(0.8) rotate(-2deg);
        }
    }

    /* Progress Tube Liquid Animation */
    .progress-tube-liquid {
        transition: height 0.8s cubic-bezier(0.65, 0, 0.35, 1);
    }

    /* Driver Badge Styles */
    .driver-badge {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem;
        background: rgba(212, 175, 55, 0.05);
        border-radius: var(--radius-sm);
        font-family: var(--font-body);
        font-size: 0.75rem;
        color: var(--color-parchment-900);
        opacity: 0.6;
        transition: opacity 0.3s ease;
    }

    .driver-badge:hover {
        opacity: 1;
    }

    .driver-icon {
        fill: var(--color-champagne-500);
    }

    /* Accessibility: Reduced Motion */
    @media (prefers-reduced-motion: reduce) {
        .assessment-card,
        .progress-tube-liquid,
        .gold-particle {
            animation: none !important;
            transition: none !important;
        }
    }

    /* Responsive Layout */
    @media (max-width: 768px) {
        .assessment-layout {
            flex-direction: column;
        }

        .assessment-progress-tube {
            width: 100%;
            max-width: 100px;
            margin: 2rem auto 0;
        }

        .stack-card-2,
        .stack-card-3 {
            display: none;
        }
    }
</style>
