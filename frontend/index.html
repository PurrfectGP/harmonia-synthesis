<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Harmonia Synthesis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 50%, #0f172a 100%); min-height: 100vh; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); }
        .gradient-text { background: linear-gradient(135deg, #ec4899, #8b5cf6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .star-title { background: linear-gradient(135deg, #fbbf24, #f59e0b, #ec4899); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-shadow: 0 0 30px rgba(251,191,36,0.3); }
        .cosmic-border { border: 2px solid transparent; background: linear-gradient(rgba(30,41,59,0.9), rgba(30,41,59,0.9)) padding-box, linear-gradient(135deg, #fbbf24, #ec4899, #8b5cf6) border-box; }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        .progress-bar { transition: width 0.3s ease; }
        .pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        .spinner { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .deep-section { border-left: 3px solid; padding-left: 1rem; }
        .deep-section.visual { border-color: #ec4899; }
        .deep-section.hla { border-color: #06b6d4; }
        .deep-section.personality { border-color: #8b5cf6; }
    </style>
</head>
<body class="text-white font-sans">
    <div class="container mx-auto px-4 py-8 max-w-5xl">
        <div class="text-center mb-8">
            <h1 class="text-5xl font-bold gradient-text mb-2">Harmonia</h1>
            <p class="text-slate-400">Visual Â· Personality Â· Genetics</p>
        </div>

        <!-- SETUP -->
        <div id="setup-step" class="glass rounded-2xl p-8 mb-6">
            <h2 class="text-2xl font-semibold mb-6">Setup</h2>
            <div class="grid md:grid-cols-2 gap-6 mb-6">
                <div><label class="block text-sm text-slate-400 mb-2">Person 1</label><input type="text" id="name1" placeholder="Enter name" class="w-full bg-slate-800/50 border border-slate-600 rounded-lg px-4 py-3 focus:border-pink-500 focus:outline-none"></div>
                <div><label class="block text-sm text-slate-400 mb-2">Person 2</label><input type="text" id="name2" placeholder="Enter name" class="w-full bg-slate-800/50 border border-slate-600 rounded-lg px-4 py-3 focus:border-purple-500 focus:outline-none"></div>
            </div>
            <div class="mb-6 p-4 glass rounded-xl">
                <h3 class="font-semibold mb-3">ğŸ–¼ï¸ Profile Photos (Enables Visual + Partner Rating)</h3>
                <div class="grid md:grid-cols-2 gap-4">
                    <div><label class="block text-xs text-slate-500 mb-1">Person 1</label><input type="file" id="image1" accept="image/*" class="w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-pink-600 file:text-white"><div id="image1-status" class="text-xs text-slate-500 mt-1"></div></div>
                    <div><label class="block text-xs text-slate-500 mb-1">Person 2</label><input type="file" id="image2" accept="image/*" class="w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-purple-600 file:text-white"><div id="image2-status" class="text-xs text-slate-500 mt-1"></div></div>
                </div>
            </div>
            <details class="mb-6"><summary class="cursor-pointer text-slate-400 text-sm hover:text-white">ğŸ§¬ Optional: Upload DNA Files (23andMe, AncestryDNA, etc.)</summary>
                <div class="mt-4 p-4 glass rounded-xl"><div class="grid md:grid-cols-2 gap-4">
                    <div><input type="file" id="dna1" accept=".csv,.txt" class="w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-cyan-600 file:text-white"><div id="dna1-status" class="text-xs mt-1"></div></div>
                    <div><input type="file" id="dna2" accept=".csv,.txt" class="w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-cyan-600 file:text-white"><div id="dna2-status" class="text-xs mt-1"></div></div>
                </div></div>
            </details>
            <details class="mb-6"><summary class="cursor-pointer text-slate-400 text-sm">ğŸ§¬ Or manually enter HLA types</summary>
                <div class="mt-4 grid md:grid-cols-2 gap-4">
                    <div><input type="text" id="hla1" placeholder="e.g., A*02:01, B*07:02" class="w-full bg-slate-800/50 border border-slate-600 rounded-lg px-4 py-2 text-sm"></div>
                    <div><input type="text" id="hla2" placeholder="e.g., A*01:01, B*08:01" class="w-full bg-slate-800/50 border border-slate-600 rounded-lg px-4 py-2 text-sm"></div>
                </div>
            </details>
            <button id="start-btn" class="w-full bg-gradient-to-r from-pink-600 to-purple-600 hover:from-pink-500 hover:to-purple-500 py-4 rounded-xl font-bold text-lg">Begin Analysis â†’</button>
        </div>

        <!-- QUIZ -->
        <div id="quiz-step" class="hidden glass rounded-2xl p-8">
            <div class="flex justify-between items-center mb-6">
                <div><span class="text-pink-400 font-bold" id="current-user">Person 1</span><span class="text-slate-500 text-sm ml-2" id="progress">Block 1/4</span></div>
                <h3 id="block-title" class="text-lg font-semibold text-purple-300">Block 1</h3>
            </div>
            <div id="questions-container" class="space-y-6"></div>
            <div class="flex gap-4 mt-6">
                <button id="skip-btn" class="flex-1 glass py-3 rounded-xl font-bold hover:bg-slate-700/50">Skip Block</button>
                <button id="next-btn" class="flex-1 bg-gradient-to-r from-pink-600 to-purple-600 py-3 rounded-xl font-bold">Next â†’</button>
            </div>
        </div>

        <!-- RATE PARTNER -->
        <div id="rate-partner-step" class="hidden glass rounded-2xl p-8 text-center">
            <div class="text-4xl mb-4">ğŸ’•</div>
            <h2 class="text-2xl font-bold mb-2">Rate Your Partner</h2>
            <p id="rate-partner-subtitle" class="text-slate-400 mb-6">How attractive do you find them?</p>
            <div class="max-w-sm mx-auto mb-6">
                <img id="partner-image-preview" src="" class="w-48 h-48 mx-auto object-cover rounded-xl border-2 border-pink-500/50 mb-4">
                <div id="rating-buttons" class="flex flex-wrap justify-center gap-2 mb-4"></div>
                <div class="text-3xl font-bold text-pink-400">Rating: <span id="selected-rating">-</span>/10</div>
            </div>
            <div class="flex gap-4 max-w-md mx-auto">
                <button id="skip-rating-btn" class="flex-1 glass py-3 rounded-xl">Skip</button>
                <button id="submit-rating-btn" class="flex-1 bg-pink-600 hover:bg-pink-500 py-3 rounded-xl font-bold" disabled>Submit Rating</button>
            </div>
        </div>

        <!-- PROCESSING -->
        <div id="processing-step" class="hidden glass rounded-2xl p-12">
            <div class="text-center mb-8"><div class="text-6xl mb-4 pulse">ğŸ”®</div><h2 class="text-2xl font-bold mb-2">Deep Compatibility Analysis</h2><p class="text-slate-400" id="processing-message">Starting...</p></div>
            <div class="mb-6"><div class="flex justify-between text-sm text-slate-400 mb-2"><span id="progress-stage">Initializing</span><span id="progress-percent">0%</span></div><div class="w-full bg-slate-700 rounded-full h-3"><div id="progress-bar" class="progress-bar bg-gradient-to-r from-pink-500 to-purple-600 h-full rounded-full" style="width:0%"></div></div></div>
            <div class="grid grid-cols-4 gap-2 text-center text-xs">
                <div id="step-profile" class="text-slate-500"><div class="w-8 h-8 mx-auto mb-1 rounded-full bg-slate-700 flex items-center justify-center">1</div>Profiles</div>
                <div id="step-visual" class="text-slate-500"><div class="w-8 h-8 mx-auto mb-1 rounded-full bg-slate-700 flex items-center justify-center">2</div>Visual</div>
                <div id="step-personality" class="text-slate-500"><div class="w-8 h-8 mx-auto mb-1 rounded-full bg-slate-700 flex items-center justify-center">3</div>Personality</div>
                <div id="step-report" class="text-slate-500"><div class="w-8 h-8 mx-auto mb-1 rounded-full bg-slate-700 flex items-center justify-center">4</div>Report</div>
            </div>
        </div>

        <!-- RESULTS - ENHANCED DEEP VERSION -->
        <div id="results-step" class="hidden space-y-6 fade-in">
            <!-- Star Sign Title Card -->
            <div class="cosmic-border rounded-2xl p-8 text-center">
                <div class="text-5xl mb-4">âœ¨</div>
                <h2 id="star-sign-title" class="text-4xl font-bold star-title mb-6">The Seekers</h2>
                <p id="star-sign-description" class="text-slate-300 leading-relaxed text-lg italic max-w-3xl mx-auto"></p>
            </div>

            <!-- Overall Score -->
            <div class="glass rounded-2xl p-8 text-center">
                <h2 class="text-xl text-slate-400 mb-2">Overall Compatibility</h2>
                <div id="overall-score" class="text-7xl font-bold gradient-text">--</div>
                <p id="vibe-check" class="text-slate-300 mt-4 text-xl italic"></p>
            </div>

            <!-- Component Scores -->
            <div class="grid md:grid-cols-3 gap-4">
                <div class="glass rounded-xl p-6 text-center border-l-4 border-pink-500">
                    <div class="text-3xl mb-2">ğŸ–¼ï¸</div>
                    <h3 class="text-pink-400 text-xs font-bold uppercase mb-1">Visual Chemistry</h3>
                    <div id="visual-score" class="text-3xl font-bold">--</div>
                    <div class="text-xs text-slate-500">50% weight</div>
                    <div id="attraction-balance" class="text-xs text-slate-400 mt-2"></div>
                </div>
                <div class="glass rounded-xl p-6 text-center border-l-4 border-purple-500">
                    <div class="text-3xl mb-2">ğŸ§ </div>
                    <h3 class="text-purple-400 text-xs font-bold uppercase mb-1">Personality Match</h3>
                    <div id="personality-score" class="text-3xl font-bold">--</div>
                    <div class="text-xs text-slate-500">35% weight</div>
                </div>
                <div class="glass rounded-xl p-6 text-center border-l-4 border-cyan-500">
                    <div class="text-3xl mb-2">ğŸ§¬</div>
                    <h3 class="text-cyan-400 text-xs font-bold uppercase mb-1">Genetic Harmony</h3>
                    <div id="hla-score" class="text-3xl font-bold">--</div>
                    <div class="text-xs text-slate-500">15% weight</div>
                </div>
            </div>

            <!-- Individual Portraits -->
            <div class="grid md:grid-cols-2 gap-4">
                <div class="glass rounded-xl p-6 border-l-4 border-pink-500">
                    <h3 id="portrait-name-1" class="text-pink-400 font-bold mb-3 text-lg">Person 1</h3>
                    <p id="portrait-1" class="text-slate-300 leading-relaxed"></p>
                </div>
                <div class="glass rounded-xl p-6 border-l-4 border-purple-500">
                    <h3 id="portrait-name-2" class="text-purple-400 font-bold mb-3 text-lg">Person 2</h3>
                    <p id="portrait-2" class="text-slate-300 leading-relaxed"></p>
                </div>
            </div>

            <!-- Quick Cards -->
            <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="glass rounded-xl p-5 border-t-4 border-green-500"><h3 class="text-green-400 text-xs font-bold uppercase mb-2">ğŸŸ¢ Green Flag</h3><p id="green-flag" class="text-sm leading-relaxed">--</p></div>
                <div class="glass rounded-xl p-5 border-t-4 border-red-500"><h3 class="text-red-400 text-xs font-bold uppercase mb-2">ğŸ”´ Red Flag</h3><p id="red-flag" class="text-sm leading-relaxed">--</p></div>
                <div class="glass rounded-xl p-5 border-t-4 border-amber-500"><h3 class="text-amber-400 text-xs font-bold uppercase mb-2">ğŸŒŸ Secret Strength</h3><p id="secret-strength" class="text-sm leading-relaxed">--</p></div>
                <div class="glass rounded-xl p-5 border-t-4 border-cyan-500"><h3 class="text-cyan-400 text-xs font-bold uppercase mb-2">ğŸ“ˆ Growth Edge</h3><p id="growth-edge" class="text-sm leading-relaxed">--</p></div>
            </div>

            <!-- Additional Cards -->
            <div class="grid md:grid-cols-2 gap-4">
                <div class="glass rounded-xl p-5 border-l-4 border-pink-400"><h3 class="text-pink-400 text-xs font-bold uppercase mb-2">ğŸ‘€ First Impression</h3><p id="first-impression" class="text-sm leading-relaxed">--</p></div>
                <div class="glass rounded-xl p-5 border-l-4 border-purple-400"><h3 class="text-purple-400 text-xs font-bold uppercase mb-2">ğŸ”‘ Long-Term Key</h3><p id="long-term-key" class="text-sm leading-relaxed">--</p></div>
            </div>

            <!-- Radar Chart & Themes -->
            <div class="grid md:grid-cols-2 gap-6">
                <div class="glass rounded-xl p-6"><h3 class="text-slate-400 text-xs font-bold uppercase mb-4">ğŸ“Š Personality Radar (Seven Deadly Sins)</h3><div class="h-72"><canvas id="radar-chart"></canvas></div></div>
                <div class="glass rounded-xl p-6"><h3 class="text-slate-400 text-xs font-bold uppercase mb-4">ğŸ”— Connection Themes</h3><div id="themes-list" class="space-y-3"></div></div>
            </div>

            <!-- Deep Analysis Sections -->
            <div class="glass rounded-xl overflow-hidden">
                <details class="group" open>
                    <summary class="p-5 cursor-pointer hover:bg-slate-700/30 font-semibold text-lg flex items-center gap-2">
                        <span class="text-purple-400">ğŸ“–</span> Deep Compatibility Analysis
                    </summary>
                    <div class="p-6 border-t border-slate-700">
                        <div id="deep-analysis" class="text-slate-300 leading-relaxed text-base deep-section personality"></div>
                    </div>
                </details>

                <details class="group border-t border-slate-700">
                    <summary class="p-5 cursor-pointer hover:bg-slate-700/30 font-semibold text-lg flex items-center gap-2">
                        <span class="text-pink-400">ğŸ–¼ï¸</span> Visual Chemistry Analysis
                    </summary>
                    <div class="p-6 border-t border-slate-700">
                        <div id="visual-deep-analysis" class="text-slate-300 leading-relaxed deep-section visual mb-4"></div>
                        <div id="visual-insight" class="text-pink-200 italic border-l-2 border-pink-500 pl-4 mt-4"></div>
                    </div>
                </details>

                <details class="group border-t border-slate-700">
                    <summary class="p-5 cursor-pointer hover:bg-slate-700/30 font-semibold text-lg flex items-center gap-2">
                        <span class="text-cyan-400">ğŸ§¬</span> Genetic Compatibility Analysis
                    </summary>
                    <div class="p-6 border-t border-slate-700">
                        <div id="hla-deep-analysis" class="text-slate-300 leading-relaxed deep-section hla mb-4"></div>
                        <div id="hla-insight" class="text-cyan-200 italic border-l-2 border-cyan-500 pl-4 mt-4"></div>
                    </div>
                </details>

                <details class="group border-t border-slate-700">
                    <summary class="p-5 cursor-pointer hover:bg-slate-700/30 font-semibold text-lg flex items-center gap-2">
                        <span class="text-amber-400">ğŸ‘€</span> Mutual Perception
                    </summary>
                    <div class="p-6 border-t border-slate-700">
                        <div id="mutual-perception" class="text-slate-300 leading-relaxed"></div>
                    </div>
                </details>

                <details class="group border-t border-slate-700">
                    <summary class="p-5 cursor-pointer hover:bg-slate-700/30 font-semibold text-lg flex items-center gap-2">
                        <span class="text-rose-400">ğŸ’•</span> How They See Each Other
                    </summary>
                    <div class="p-6 border-t border-slate-700 grid md:grid-cols-2 gap-6">
                        <div>
                            <h4 id="perception-1-title" class="text-pink-400 font-bold mb-2">Person 1's View</h4>
                            <p id="perception-1" class="text-slate-300 text-sm leading-relaxed"></p>
                        </div>
                        <div>
                            <h4 id="perception-2-title" class="text-purple-400 font-bold mb-2">Person 2's View</h4>
                            <p id="perception-2" class="text-slate-300 text-sm leading-relaxed"></p>
                        </div>
                    </div>
                </details>
            </div>

            <!-- Verdict -->
            <div class="glass rounded-xl p-8 border-2 border-purple-500/30 text-center">
                <h3 class="text-purple-400 text-sm font-bold uppercase mb-4">ğŸ’œ The Verdict</h3>
                <p id="compatibility-verdict" class="text-xl text-slate-200 leading-relaxed italic max-w-2xl mx-auto"></p>
            </div>

            <!-- Actions -->
            <div class="flex gap-4">
                <button id="download-btn" class="flex-1 glass py-4 rounded-xl font-bold hover:bg-slate-700/50 flex items-center justify-center gap-2"><i data-lucide="download"></i>Download Full Report</button>
                <button id="restart-btn" class="flex-1 glass py-4 rounded-xl font-bold hover:bg-slate-700/50 flex items-center justify-center gap-2"><i data-lucide="refresh-cw"></i>Start Over</button>
            </div>
        </div>
    </div>

    <script>
    const MIN_WORDS = 25, MAX_WORDS = 150;
    const QUESTIONS = {
        "Block 1: Social & Interpersonal": [
            {id: "social_1", title: "The Group Dinner Check", question: "The bill arrives at a group dinner. Everyone contributed differently. What's your approach?"},
            {id: "social_2", title: "The Stranger's Story", question: "At a party, someone you've just met starts telling you a deeply personal story. How do you respond?"}
        ],
        "Block 2: Stress & Problem-Solving": [
            {id: "stress_1", title: "The Unexpected Expense", question: "Your car needs a $1,200 repair you didn't budget for. Walk me through your thought process."},
            {id: "stress_2", title: "The Traffic Jam", question: "You're stuck in traffic and will be late to something important. What goes through your mind?"}
        ],
        "Block 3: Decision-Making & Values": [
            {id: "values_1", title: "The Found Wallet", question: "You find a wallet with $300 cash in a parking lot. What do you do and why?"},
            {id: "values_2", title: "The Weekend Off", question: "You have a completely free weekend. How do you spend it?"}
        ],
        "Block 4: Conflict & Disagreement": [
            {id: "conflict_1", title: "The Restaurant Choice", question: "You're excited about a new restaurant, but your friend suggests one you find mediocre. How do you respond?"},
            {id: "conflict_2", title: "The Line Cutter", question: "Someone clearly cuts in front of you in a long queue. What do you do?"}
        ]
    };

    let state = { user1: "", user2: "", hla1: "", hla2: "", currentUser: 1, currentBlock: 0, blocks: Object.keys(QUESTIONS), responses: { 1: {}, 2: {} }, userId1: null, userId2: null, radarChart: null, partnerRating: null };

    function countWords(t) { return t.trim().split(/\s+/).filter(w => w.length > 0).length; }
    function showStep(id) { ["setup-step","quiz-step","rate-partner-step","processing-step","results-step"].forEach(s => document.getElementById(s).classList.add("hidden")); document.getElementById(id).classList.remove("hidden"); window.scrollTo({top:0,behavior:'smooth'}); if(typeof lucide!=="undefined")lucide.createIcons(); }
    function updateProgress(p,s,m) { document.getElementById("progress-bar").style.width=p+"%"; document.getElementById("progress-percent").textContent=p+"%"; document.getElementById("progress-stage").textContent=s; document.getElementById("processing-message").textContent=m; ["step-profile","step-visual","step-personality","step-report"].forEach((st,i)=>{ const el=document.getElementById(st); if(p>=(i+1)*25){ el.classList.remove("text-slate-500"); el.classList.add("text-green-400"); el.querySelector("div").classList.remove("bg-slate-700"); el.querySelector("div").classList.add("bg-green-600"); } }); }

    async function uploadImage(userId, inp, stat) { const f=inp.files[0]; if(!f)return; stat.textContent="Uploading..."; const fd=new FormData(); fd.append("file",f); try{ const r=await fetch(`/api/upload-image/${userId}`,{method:"POST",body:fd}); const d=await r.json(); stat.textContent=`âœ… Quality: ${d.features?.quality_score||'N/A'}%`; stat.className="text-xs text-green-400 mt-1"; }catch(e){ stat.textContent="âŒ Failed"; stat.className="text-xs text-red-400 mt-1"; } }
    async function uploadDNA(userId, inp, stat) { const f=inp.files[0]; if(!f)return; stat.textContent="Parsing..."; const fd=new FormData(); fd.append("file",f); try{ const r=await fetch(`/api/upload-dna/${userId}`,{method:"POST",body:fd}); const d=await r.json(); stat.textContent=`âœ… ${d.hla_alleles}`; stat.className="text-xs text-green-400 mt-1"; }catch(e){ stat.textContent="âŒ Failed"; stat.className="text-xs text-red-400 mt-1"; } }

    async function generateResponse(qid, q, sentiment) {
        const spin=document.getElementById(`spinner-${qid}`);
        const ta=document.getElementById(`answer-${qid}`);
        spin.classList.remove("hidden");
        try{
            const r=await fetch("/api/generate-response",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({question:q,sentiment})});
            const d=await r.json();
            ta.value=d.response;
            const wc=countWords(d.response);
            const ws=document.getElementById(`wc-${qid}`);
            ws.textContent=wc;
            ws.className=(wc>=MIN_WORDS&&wc<=MAX_WORDS)?"text-green-400":"text-red-400";
        }catch(e){console.error(e);}
        spin.classList.add("hidden");
    }

    async function startQuestionnaire() { state.user1=document.getElementById("name1").value||"Person 1"; state.user2=document.getElementById("name2").value||"Person 2"; state.hla1=document.getElementById("hla1")?.value||""; state.hla2=document.getElementById("hla2")?.value||""; state.userId1=`u1_${Date.now()}`; state.userId2=`u2_${Date.now()}`; const i1=document.getElementById("image1"),i2=document.getElementById("image2"); if(i1.files[0])await uploadImage(state.userId1,i1,document.getElementById("image1-status")); if(i2.files[0])await uploadImage(state.userId2,i2,document.getElementById("image2-status")); const d1=document.getElementById("dna1"),d2=document.getElementById("dna2"); if(d1.files[0])await uploadDNA(state.userId1,d1,document.getElementById("dna1-status")); if(d2.files[0])await uploadDNA(state.userId2,d2,document.getElementById("dna2-status")); state.currentUser=1; state.currentBlock=0; showStep("quiz-step"); renderBlock(); }

    function renderBlock() {
        const bn=state.blocks[state.currentBlock];
        const qs=QUESTIONS[bn];
        document.getElementById("current-user").textContent=state.currentUser===1?state.user1:state.user2;
        document.getElementById("progress").textContent=`Block ${state.currentBlock+1}/${state.blocks.length}`;
        document.getElementById("block-title").textContent=bn;
        const c=document.getElementById("questions-container");
        c.innerHTML="";
        qs.forEach(q=>{
            const d=document.createElement("div");
            d.className="glass rounded-xl p-5 mb-4";
            d.innerHTML=`
                <div class="flex justify-between items-start mb-2">
                    <div class="font-semibold text-pink-300">${q.title}</div>
                    <div class="flex items-center gap-2">
                        <button onclick="generateResponse('${q.id}','${q.question.replace(/'/g,"\\'")}','positive')" class="text-xs bg-green-600 hover:bg-green-500 px-3 py-1.5 rounded-lg flex items-center gap-1">ğŸ‘ Gen+</button>
                        <button onclick="generateResponse('${q.id}','${q.question.replace(/'/g,"\\'")}','negative')" class="text-xs bg-red-600 hover:bg-red-500 px-3 py-1.5 rounded-lg flex items-center gap-1">ğŸ‘ Gen-</button>
                        <div id="spinner-${q.id}" class="hidden w-5 h-5 border-2 border-pink-500 border-t-transparent rounded-full spinner"></div>
                    </div>
                </div>
                <p class="text-slate-400 text-sm mb-3">${q.question}</p>
                <textarea id="answer-${q.id}" class="w-full bg-slate-900/50 border border-slate-600 rounded-lg p-3 h-28 focus:border-pink-500 focus:outline-none" placeholder="${MIN_WORDS}-${MAX_WORDS} words..."></textarea>
                <div class="text-xs text-slate-500 mt-1">Words: <span id="wc-${q.id}">0</span>/${MIN_WORDS}-${MAX_WORDS}</div>
            `;
            c.appendChild(d);
            document.getElementById(`answer-${q.id}`).addEventListener("input",e=>{
                const wc=countWords(e.target.value);
                const ws=document.getElementById(`wc-${q.id}`);
                ws.textContent=wc;
                ws.className=(wc>=MIN_WORDS&&wc<=MAX_WORDS)?"text-green-400":"text-red-400";
            });
        });
    }

    function validateAndSaveBlock() { const bn=state.blocks[state.currentBlock]; let valid=0; QUESTIONS[bn].forEach(q=>{ const a=document.getElementById(`answer-${q.id}`)?.value||""; if(countWords(a)>=MIN_WORDS&&countWords(a)<=MAX_WORDS){ state.responses[state.currentUser][q.id]=a; valid++; } }); return valid>=1; }

    async function checkAndShowPartnerRating() { const rId=state.currentUser===1?state.userId1:state.userId2; const pId=state.currentUser===1?state.userId2:state.userId1; const pName=state.currentUser===1?state.user2:state.user1; try{ const r=await fetch(`/api/get-partner-image/${rId}?partner_id=${pId}`); const d=await r.json(); if(d.has_image&&d.image_base64){ state.partnerRating=null; document.getElementById("rate-partner-subtitle").textContent=`How attractive do you find ${pName}?`; document.getElementById("partner-image-preview").src=`data:image/jpeg;base64,${d.image_base64}`; const bc=document.getElementById("rating-buttons"); bc.innerHTML=""; for(let i=1;i<=10;i++){ const b=document.createElement("button"); b.className="w-10 h-10 rounded-full bg-slate-700 hover:bg-pink-600 font-bold transition-colors"; b.textContent=i; b.onclick=()=>selectRating(i); bc.appendChild(b); } showStep("rate-partner-step"); return true; } }catch(e){} return false; }

    function selectRating(r) { state.partnerRating=r; document.getElementById("selected-rating").textContent=r; document.getElementById("submit-rating-btn").disabled=false; const btns=document.getElementById("rating-buttons").querySelectorAll("button"); btns.forEach((b,i)=>{ if(i+1<=r){ b.classList.remove("bg-slate-700"); b.classList.add("bg-pink-600"); }else{ b.classList.remove("bg-pink-600"); b.classList.add("bg-slate-700"); } }); }

    async function submitPartnerRating() { if(state.partnerRating){ const rId=state.currentUser===1?state.userId1:state.userId2; const pId=state.currentUser===1?state.userId2:state.userId1; await fetch("/api/rate-partner-image",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({rater_id:rId,partner_id:pId,rating:state.partnerRating})}); } continueAfterRating(); }

    async function continueAfterRating() { showStep("processing-step"); updateProgress(5,"Submitting",`Processing ${state.currentUser===1?state.user1:state.user2}...`); const uId=state.currentUser===1?state.userId1:state.userId2; const uName=state.currentUser===1?state.user1:state.user2; const hla=state.currentUser===1?state.hla1:state.hla2; await fetch("/api/submit-profile",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:uId,user_name:uName,responses:state.responses[state.currentUser],hla_data:hla})}); let att=0; while(att<120){ await new Promise(r=>setTimeout(r,1000)); const r=await fetch(`/api/status/${uId}`); const d=await r.json(); if(d.progress)updateProgress(d.progress.percent,d.progress.stage,d.progress.message); if(d.ready)break; att++; } if(state.currentUser===1){ state.currentUser=2; state.currentBlock=0; state.partnerRating=null; alert(`${state.user1} complete! Pass device to ${state.user2}.`); showStep("quiz-step"); renderBlock(); }else{ await runComparison(); } }

    function skipBlock() { state.currentBlock++; if(state.currentBlock>=state.blocks.length)finishCurrentUser(); else renderBlock(); }
    function nextBlock() { if(!validateAndSaveBlock()){ alert(`Answer at least 1 question (${MIN_WORDS}-${MAX_WORDS} words).`); return; } skipBlock(); }
    async function finishCurrentUser() { if(!await checkAndShowPartnerRating())await continueAfterRating(); }

    async function runComparison() { updateProgress(50,"Comparing","Running deep analysis..."); try{ updateProgress(60,"Visual","Analyzing visual chemistry..."); await new Promise(r=>setTimeout(r,500)); updateProgress(70,"Personality","Analyzing personality..."); await new Promise(r=>setTimeout(r,500)); updateProgress(80,"AI","Generating deep insights..."); const r=await fetch("/api/compare",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_a_id:state.userId1,user_b_id:state.userId2})}); if(!r.ok)throw new Error((await r.json()).detail||"Failed"); updateProgress(95,"Report","Finalizing report..."); const d=await r.json(); updateProgress(100,"Complete","Done!"); await new Promise(r=>setTimeout(r,500)); renderResults(d); }catch(e){ console.error(e); alert("Error: "+e.message); updateProgress(0,"Error",e.message); } }

    function renderResults(d) {
        showStep("results-step");
        const p1=d.chart_data?.p1_name||"Person 1", p2=d.chart_data?.p2_name||"Person 2";

        // Star sign title and description
        document.getElementById("star-sign-title").textContent=d.analysis?.star_sign_title||"The Seekers";
        document.getElementById("star-sign-description").textContent=d.analysis?.star_sign_description||"";

        // Scores
        document.getElementById("overall-score").textContent=`${d.overall_score||50}%`;
        document.getElementById("vibe-check").textContent=d.analysis?.ui_cards?.vibe_check||"A unique connection.";
        document.getElementById("visual-score").textContent=`${Math.round(d.components?.visual?.score||50)}%`;
        document.getElementById("personality-score").textContent=`${Math.round(d.components?.personality?.score||50)}%`;
        document.getElementById("hla-score").textContent=`${Math.round(d.components?.hla?.score||50)}%`;

        // Attraction balance
        const balance = d.components?.visual?.details?.attraction_balance || "";
        document.getElementById("attraction-balance").textContent=balance?`(${balance})`:"";

        // Portraits
        document.getElementById("portrait-name-1").textContent=p1;
        document.getElementById("portrait-name-2").textContent=p2;
        document.getElementById("portrait-1").textContent=d.analysis?.individual_portraits?.[p1]||"";
        document.getElementById("portrait-2").textContent=d.analysis?.individual_portraits?.[p2]||"";

        // Quick cards
        document.getElementById("green-flag").textContent=d.analysis?.ui_cards?.green_flag||"";
        document.getElementById("red-flag").textContent=d.analysis?.ui_cards?.red_flag||"";
        document.getElementById("secret-strength").textContent=d.analysis?.ui_cards?.secret_strength||"";
        document.getElementById("growth-edge").textContent=d.analysis?.ui_cards?.growth_edge||"";
        document.getElementById("first-impression").textContent=d.analysis?.ui_cards?.first_impression||"";
        document.getElementById("long-term-key").textContent=d.analysis?.ui_cards?.long_term_key||"";

        // Themes
        const tl=document.getElementById("themes-list");
        tl.innerHTML="";
        (d.analysis?.themes||[]).forEach(t=>{
            const div=document.createElement("div");
            div.className="glass rounded-lg p-4";
            div.innerHTML=`<div class="font-bold text-pink-300 mb-1">${t}</div><div class="text-sm text-slate-400">${d.analysis?.ui_cards?.theme_descriptions?.[t]||""}</div>`;
            tl.appendChild(div);
        });

        // Deep analysis sections
        document.getElementById("deep-analysis").textContent=d.analysis?.deep_analysis||"";
        document.getElementById("visual-deep-analysis").textContent=d.analysis?.visual_deep_analysis||"";
        document.getElementById("visual-insight").textContent=d.analysis?.visual_insight||"";
        document.getElementById("hla-deep-analysis").textContent=d.analysis?.hla_deep_analysis||"";
        document.getElementById("hla-insight").textContent=d.analysis?.hla_insight||"";
        document.getElementById("mutual-perception").textContent=d.analysis?.perceived_similarity||"";
        document.getElementById("compatibility-verdict").textContent=d.analysis?.compatibility_verdict||"";

        // Partner perceptions
        const pp = d.partner_perceptions || {};
        document.getElementById("perception-1-title").textContent=`${p1}'s View of ${p2}`;
        document.getElementById("perception-2-title").textContent=`${p2}'s View of ${p1}`;
        document.getElementById("perception-1").textContent=pp.p1_sees_p2?.what_draws_them||"No perception data available.";
        document.getElementById("perception-2").textContent=pp.p2_sees_p1?.what_draws_them||"No perception data available.";

        if(d.chart_data)renderRadarChart(d.chart_data);
        state.reportFile=d.report_file;
        if(typeof lucide!=="undefined")lucide.createIcons();
    }

    function renderRadarChart(cd) { const ctx=document.getElementById("radar-chart").getContext("2d"); if(state.radarChart)state.radarChart.destroy(); state.radarChart=new Chart(ctx,{ type:"radar", data:{ labels:cd.labels, datasets:[{ label:cd.p1_name, data:cd.p1_scores, fill:true, backgroundColor:"rgba(236,72,153,0.2)", borderColor:"#ec4899", pointBackgroundColor:"#ec4899" },{ label:cd.p2_name, data:cd.p2_scores, fill:true, backgroundColor:"rgba(139,92,246,0.2)", borderColor:"#8b5cf6", pointBackgroundColor:"#8b5cf6" }] }, options:{ responsive:true, maintainAspectRatio:false, scales:{ r:{ grid:{color:"rgba(255,255,255,0.1)"}, angleLines:{color:"rgba(255,255,255,0.1)"}, pointLabels:{color:"#cbd5e1",font:{size:11}}, ticks:{display:false}, suggestedMin:-5, suggestedMax:5 } }, plugins:{ legend:{labels:{color:"white"}} } } }); }

    function downloadReport() { if(state.userId1&&state.userId2)window.open(`/api/download-report/${state.userId1}/${state.userId2}`,"_blank"); else alert("Report not ready."); }

    document.addEventListener("DOMContentLoaded",()=>{ document.getElementById("start-btn").addEventListener("click",startQuestionnaire); document.getElementById("skip-btn").addEventListener("click",skipBlock); document.getElementById("next-btn").addEventListener("click",nextBlock); document.getElementById("download-btn").addEventListener("click",downloadReport); document.getElementById("restart-btn").addEventListener("click",()=>location.reload()); document.getElementById("submit-rating-btn").addEventListener("click",submitPartnerRating); document.getElementById("skip-rating-btn").addEventListener("click",()=>continueAfterRating()); if(typeof lucide!=="undefined")lucide.createIcons(); });
    </script>
</body>
</html>